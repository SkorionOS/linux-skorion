# Maintainer: Jan Alexander Steffens (heftig) <heftig@archlinux.org>
# Maintainer: Joaquín I. Aramendía (samsagax) <samsagaxg@gmail.com>

pkgbase=linux-skchos
pkgver=6.17.7
_pkgver=6.17.7-ba01
pkgrel=1
pkgdesc='Linux SkorionOS'
# _srctag=v$(echo $pkgver | sed -E 's#.sk.#-sk-#')
_srctag=v${pkgver%.*}-${pkgver##*.}
url="https://github.com/3003n/linux/commits/$_srctag"
arch=(x86_64)
license=(GPL2)
makedepends=(
  bc  
  cpio
  curl
  gettext
  git
  libelf
  make
  pahole
  perl
  python
  tar
  xz

  # htmldocs
  #graphviz
  #imagemagick
  #python-sphinx
  #texlive-latexextra
)
options=('!strip')
# _srcname=linux-skorionos
# _srcname=linux-$_pkgver
_srcname=patchwork-$_pkgver
source=(
  "https://github.com/hhd-dev/patchwork/archive/refs/tags/$_pkgver.tar.gz"
  # "https://github.com/3003n/linux/archive/refs/tags/$_pkgver.tar.gz"
  config  # the main kernel config file
  # config-chimera # our config that will be merged
  config-bazzite
  config-sk

  # R0001-Revert-drm-amd-display-enable-tf_blend-if-supported-.patch
  # R0002-Revert-drm-re-allow-no-op-changes-on-non-primary-pla.patch

  "0001-cjktty-6.16.patch::https://github.com/bigshans/cjktty-patches/raw/master/v6.x/cjktty-6.16.patch"
  "0002-cjktty-32.patch::https://github.com/bigshans/cjktty-patches/raw/master/cjktty-add-cjk32x32-font-data.patch"

  # 0006-s5-power-v4.patch
  # 0007-asus-ally-hid.patch

  0034-platform-x86-msi-wmi-platform-update-tdp-range.patch
  # A008-Add-EXTRAVERSION.patch
)

validpgpkeys=(
  ABAF11C65A2970B130ABE3C479BE3E4300411886  # Linus Torvalds
  647F28654894E3BD457199BE38DBBDC86092693E  # Greg Kroah-Hartman
  A2FF3A36AAA56654109064AB19802F8B0D70FC30  # Jan Alexander Steffens (heftig)
  C7E7849466FE2358343588377258734B41C31549  # David Runge <dvzrv@archlinux.org>
)

sha256sums=('f979542f6711d2eb5ab1b8f35e0a93e68c1051ee8b8d3a146fb3aaec97984e59'
            '0ffa75682353e604dd59e7bafc0d88c46caa221631f6b7783a78b0abe9077c16'
            '4e0bc06b0cd7a5bc4ae687b12343bbc28bdbf2465e68e9a021b9370b5743f5ff'
            '859e09fd34b224cbb3675fc984cd4dc4f08ea74a3c48970fe7248358be553180'
            'a93750d533c660f7e6a8536998dc607884b6b69d934f125d6950a86c2a601d47'
            'c648ff21f0a5714743bbae85d6c6e1ed2bf961b6bca976d4c6b4c8d3f6b2739f'
            'f21993ad7e78e7e89f00e37c9d17ed7976f733684be97ea5ec7ccb5eec563b6b')

export KBUILD_BUILD_HOST=archlinux
export KBUILD_BUILD_USER=$pkgbase
export KBUILD_BUILD_TIMESTAMP="$(date -Ru${SOURCE_DATE_EPOCH:+d @$SOURCE_DATE_EPOCH})"
export KCFLAGS="-DAMD_PRIVATE_COLOR"

_make() {
  test -s version
  make KERNELRELEASE="$(<version)" "$@"
}

prepare() {
  # dir=$(echo $_srctag | sed 's/^v/linux-/')
  # dir="linux-$_pkgver"
  # mv $dir $_srcname
  cd $_srcname

  # mkdir -p submodules
  # git -c advice.detachedHead=false clone -b hwmon https://github.com/honjow/msi-ec.git submodules/msi-ec
  # cp -f submodules/msi-ec/ec_memory_configuration.h  drivers/platform/x86/msi-ec.h
  # cp -f submodules/msi-ec/msi-ec.c  drivers/platform/x86/msi-ec.c
  # sed -i 's/#include "ec_memory_configuration.h"/#include "msi-ec.h"/' drivers/platform/x86/msi-ec.c
  # sed -i 's/MODULE_VERSION("0.09");/MODULE_VERSION("0.10");/' drivers/platform/x86/msi-ec.c

  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"

    # if .patch.zst , remove .zst
    [[ $src = *.patch.zst ]] && src="${src%.zst}" || :

    [[ $src = *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 < "../$src"
  done

  # Fetch custom drivers automatically
  echo "Fetching custom driver submodules..."
  local tmpdir=$(mktemp -d)
  
  # Shallow clone to get submodule info
  git clone --depth=1 --branch $_pkgver --filter=blob:none \
    https://github.com/hhd-dev/patchwork.git "$tmpdir/patchwork" || {
    echo "Warning: failed to clone patchwork, cleaning drivers/custom"
    find drivers/custom -type d -empty -delete
    echo "" > drivers/custom/Makefile
    echo "" > drivers/custom/Kconfig
    rm -rf "$tmpdir"
    return
  }
  
  cd "$tmpdir/patchwork"
  
  # Get submodule info and download each one
  git submodule init drivers/custom
  git submodule status drivers/custom/* 2>/dev/null | while read -r status_line; do
    commit=$(echo "$status_line" | awk '{print $1}' | sed 's/^[-+]//')
    path=$(echo "$status_line" | awk '{print $2}')
    name=$(basename "$path")
    url=$(git config --file .gitmodules --get "submodule.$path.url")
    
    if [ -n "$commit" ] && [ -n "$url" ]; then
      echo "  -> Downloading $name at ${commit:0:8}..."
      mkdir -p "$srcdir/$_srcname/$path"
      
      # Try archive download first
      if ! curl -sfL "$url/archive/$commit.tar.gz" | \
        tar -xz -C "$srcdir/$_srcname/$path" --strip-components=1 2>/dev/null; then
        
        # Fallback to shallow git clone
        echo "     -> Using git clone fallback..."
        local clone_tmp="$tmpdir/${name}_clone"
        if git clone --depth=50 "$url" "$clone_tmp" 2>/dev/null; then
          (cd "$clone_tmp" && git checkout $commit 2>/dev/null && rm -rf .git) && \
            cp -r "$clone_tmp"/* "$srcdir/$_srcname/$path/" 2>/dev/null || \
            echo "     Warning: failed to checkout $name"
          rm -rf "$clone_tmp"
        else
          echo "     Warning: failed to download $name"
        fi
      fi
    fi
  done
  
  cd "$srcdir/$_srcname"
  rm -rf "$tmpdir"
  
  # Clean up any empty directories
  find drivers/custom -type d -empty -delete

  echo "Setting version..."
  echo "${pkgbase#linux}" > localversion.10-pkgname
  echo "-$pkgrel" > localversion.20-pkgrel
  make defconfig
  make -s kernelrelease > version
  make mrproper

  echo "Setting config..."
  cp ../config .config
  _make olddefconfig
  # scripts/kconfig/merge_config.sh -m .config ../config-chimera
  scripts/kconfig/merge_config.sh -m .config ../config-bazzite
  scripts/kconfig/merge_config.sh -m .config ../config-sk
  diff -u ../config .config || :

  echo "Prepared $pkgbase version $(<version)"
}

build() {
  cd $_srcname
  _make all
}

_package() {
  pkgdesc="The $pkgdesc kernel and modules"
  depends=(
    coreutils
    initramfs
    kmod
  )
  optdepends=(
    'wireless-regdb: to set the correct wireless channels of your country'
    'linux-firmware: firmware images needed for some devices'
  )
  provides=(
    KSMBD-MODULE
    VIRTUALBOX-GUEST-MODULES
    WIREGUARD-MODULE
  )
  replaces=(
    virtualbox-guest-modules-arch
    wireguard-arch
  )

  cd $_srcname
  local modulesdir="$pkgdir/usr/lib/modules/$(<version)"

  echo "Installing boot image..."
  # systemd expects to find the kernel here to allow hibernation
  # https://github.com/systemd/systemd/commit/edda44605f06a41fb86b7ab8128dcf99161d2344
  install -Dm644 "$(_make -s image_name)" "$modulesdir/vmlinuz"

  # Used by mkinitcpio to name the kernel
  echo "$pkgbase" | install -Dm644 /dev/stdin "$modulesdir/pkgbase"

  echo "Installing modules..."
  ZSTD_CLEVEL=19 _make INSTALL_MOD_PATH="$pkgdir/usr" INSTALL_MOD_STRIP=1 \
    DEPMOD=/doesnt/exist modules_install  # Suppress depmod

  # Install custom drivers configuration files
  echo "Installing custom drivers configuration files..."
  _make -C drivers/custom INSTALL_DIR="$pkgdir" install || echo "Warning: custom drivers install failed"

  # remove build links
  rm "$modulesdir"/build
}

_package-headers() {
  pkgdesc="Headers and scripts for building modules for the $pkgdesc kernel"
  depends=(pahole)

  cd $_srcname
  local builddir="$pkgdir/usr/lib/modules/$(<version)/build"

  echo "Installing build files..."
  install -Dt "$builddir" -m644 .config Makefile Module.symvers System.map \
    localversion.* version vmlinux
  install -Dt "$builddir/kernel" -m644 kernel/Makefile
  install -Dt "$builddir/arch/x86" -m644 arch/x86/Makefile
  cp -t "$builddir" -a scripts

  # required when STACK_VALIDATION is enabled
  install -Dt "$builddir/tools/objtool" tools/objtool/objtool

  # required when DEBUG_INFO_BTF_MODULES is enabled
  install -Dt "$builddir/tools/bpf/resolve_btfids" tools/bpf/resolve_btfids/resolve_btfids

  echo "Installing headers..."
  cp -t "$builddir" -a include
  cp -t "$builddir/arch/x86" -a arch/x86/include
  install -Dt "$builddir/arch/x86/kernel" -m644 arch/x86/kernel/asm-offsets.s

  install -Dt "$builddir/drivers/md" -m644 drivers/md/*.h
  install -Dt "$builddir/net/mac80211" -m644 net/mac80211/*.h

  # https://bugs.archlinux.org/task/13146
  install -Dt "$builddir/drivers/media/i2c" -m644 drivers/media/i2c/msp3400-driver.h

  # https://bugs.archlinux.org/task/20402
  install -Dt "$builddir/drivers/media/usb/dvb-usb" -m644 drivers/media/usb/dvb-usb/*.h
  install -Dt "$builddir/drivers/media/dvb-frontends" -m644 drivers/media/dvb-frontends/*.h
  install -Dt "$builddir/drivers/media/tuners" -m644 drivers/media/tuners/*.h

  # https://bugs.archlinux.org/task/71392
  install -Dt "$builddir/drivers/iio/common/hid-sensors" -m644 drivers/iio/common/hid-sensors/*.h

  echo "Installing KConfig files..."
  find . -name 'Kconfig*' -exec install -Dm644 {} "$builddir/{}" \;

  echo "Removing unneeded architectures..."
  local arch
  for arch in "$builddir"/arch/*/; do
    [[ $arch = */x86/ ]] && continue
    echo "Removing $(basename "$arch")"
    rm -r "$arch"
  done

  echo "Removing documentation..."
  rm -r "$builddir/Documentation"

  echo "Removing broken symlinks..."
  find -L "$builddir" -type l -printf 'Removing %P\n' -delete

  echo "Removing loose objects..."
  find "$builddir" -type f -name '*.o' -printf 'Removing %P\n' -delete

  echo "Stripping build tools..."
  local file
  while read -rd '' file; do
    case "$(file -Sib "$file")" in
      application/x-sharedlib\;*)      # Libraries (.so)
        strip -v $STRIP_SHARED "$file" ;;
      application/x-archive\;*)        # Libraries (.a)
        strip -v $STRIP_STATIC "$file" ;;
      application/x-executable\;*)     # Binaries
        strip -v $STRIP_BINARIES "$file" ;;
      application/x-pie-executable\;*) # Relocatable binaries
        strip -v $STRIP_SHARED "$file" ;;
    esac
  done < <(find "$builddir" -type f -perm -u+x ! -name vmlinux -print0)

  echo "Stripping vmlinux..."
  strip -v $STRIP_STATIC "$builddir/vmlinux"

  echo "Adding symlink..."
  mkdir -p "$pkgdir/usr/src"
  ln -sr "$builddir" "$pkgdir/usr/src/$pkgbase"
}

_package-docs() {
  pkgdesc="Documentation for the $pkgdesc kernel"

  cd $_srcname
  local builddir="$pkgdir/usr/lib/modules/$(<version)/build"

  echo "Installing documentation..."
  local src dst
  while read -rd '' src; do
    dst="${src#Documentation/}"
    dst="$builddir/Documentation/${dst#output/}"
    install -Dm644 "$src" "$dst"
  done < <(find Documentation -name '.*' -prune -o ! -type d -print0)

  echo "Adding symlink..."
  mkdir -p "$pkgdir/usr/share/doc"
  ln -sr "$builddir/Documentation" "$pkgdir/usr/share/doc/$pkgbase"
}

pkgname=(
  "$pkgbase"
  "$pkgbase-headers"
  #"$pkgbase-docs"
)
for _p in "${pkgname[@]}"; do
  eval "package_$_p() {
    $(declare -f "_package${_p#$pkgbase}")
    _package${_p#$pkgbase}
  }"
done

# vim:set ts=8 sts=2 sw=2 et:
